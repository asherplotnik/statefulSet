---
# Source: mongodb-replicaset/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mongodb-exec
  namespace: default
---
# Source: mongodb-replicaset/templates/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: mongo-keyfile
  namespace: default
type: Opaque
data:
  keyfile: "bWFIelpUNmIySVpibzV1a1VHcDJjbHFhWXlaWTk5VXMzdU1wRGRpMS9YYlMwWm1mQzB0RUdRYVBwZXhudU1FSnZoaWk5U1hZTDhJRnlPcGQyeXROc1ZBbnRXaFp1V1VockRsZ0RVZ1prTWQyUlJMVGI4eWFRUzBsWS9CRXFmY2lBVk5jdmxDZ0hReTJ2dm9jLzVwVEVBc3YyRXhWRVR4RW0ra0pKVW5aMXh1WkpNdloyWkRvMnhxOHlvWHZTd3g5VUNyQlh3b1B5M0pYeEFodlFQb1BpK0FWbUkzTVJLK2JpNDRtam5hTFdkWU5TZFBMZ2V0RUtXMVkzZ2NlUktCK2xHTjFtZkRJMXRWOW5HVWJOR1kwK3psYkcyeEVVblBjbjBBMGk2MksrSGNQMWpRanJNOWhLNnVuL2MxaHIrVjhvZFl4bjdhamNDUVRZMUkvRlRlbEs2Q1ZwRXNRdTdEbUo1SmpxQndYZE9rUjNJWGRXREQ1NmRWbnFSeTJsd3pwVHRoTkdKa1BOYVFoRGxxTkdyY1FLWnlwOVFGTjZaektIdjNiTGpvT3lWMHlzeDI1ZlFsdXpKemJQRm0rd3BZTG9sNGlZYjk5dGF3NlpCWVNBcHBEMFFoUnFTdUt6aHQ2QlFML3JqOXlSTVBGTDJsWC94aTN5UzU4YURSZUR0VXIxNTdidzJMM1NDanU1WlpjbDUrZTRVTk9Ub3g0UEN6b0JkaVduZlNwQzhrM3lhczZUZ0dPa1pjN0ZQREV2N1dtYWFPSHBaSFAvQUxFamIyakdmVDJqTVlWNkJFT2VJand4eXRiRk9wbHl5Z25CRmRaWnhJVER4QloxWGNJaXhnL3ZYSktCNm1KSVMySVhOeXBpWGdZS0I3dllGQkJRVHVhUExIQVBZVElYd0x2T3hWeXdSbS9iQnJSbGxISU5QYzFPdkhLS0VySXp2U1VPZ0MramF2VGJGOU5hSWtUbUxyWmM4Ny81VXIxZEdKM091NXNndFNEb2Vvc0svQnhvL2VDc2NtZ1dWZkUvSTFwamVoMHdIUzA0bGVzMjBPa29Dd1hGZ1BsaXVnSnVFVVcvbGdYNWRuVCthWFBpbVRwaVNMSHVMS3lDZmZITjhjSllBVlBFODBET2ZRZ21EOTdqWHpIU3V2ZGlmc0IycnltVGxhcHJmQ2RRS0VQWW1kdFdyZnErM0FXRHFiVHd1VnkzVDdMVGVQOXhqZ3Z1cWNPbEVYK3RJMTdMdm90c3pJRzVTb29veHdUTGhIOVZqTE0rYmcxa2FMQm9IMkRNZmJDQzkrSWUrQ0s4TDlpamNiM0xZeVY5eGt3UlBaYmlxMEpnckhE"
---
# Source: mongodb-replicaset/templates/configMap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-rs-init
data:
  init.js: |
    rs.initiate({
      _id: "rs0",
      members: [
        { _id: 0, host: "mongodb-replicaset-0.mongodb-replicaset:27017" },
        { _id: 1, host: "mongodb-replicaset-1.mongodb-replicaset:27017" },
        { _id: 2, host: "mongodb-replicaset-2.mongodb-replicaset:27017" }
      ]
    });
---
# Source: mongodb-replicaset/templates/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: mongodb-exec-role
  namespace: default
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/exec"]
    verbs: ["get", "create"]
---
# Source: mongodb-replicaset/templates/serviceaccount.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: mongodb-exec-rolebinding
  namespace: default
subjects:
  - kind: ServiceAccount
    name: mongodb-exec
    namespace: default
roleRef:
  kind: Role
  name: mongodb-exec-role
  apiGroup: rbac.authorization.k8s.io
---
# Source: mongodb-replicaset/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: mongodb-replicaset
  labels:
    app: mongodb
spec:
  clusterIP: None
  ports:
    - port: 27017
      name: mongo
  selector:
    app: mongodb
---
# Source: mongodb-replicaset/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb-replicaset
  labels:
    app: mongodb
spec:
  serviceName: mongodb-replicaset
  replicas: 3
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      initContainers:
        - name: copy-keyfile
          image: busybox
          command:
            - "sh"
            - "-c"
            - |
              cp /tmp/keyfile/keyfile /etc/mongodb/keyfile && chmod 0400 /etc/mongodb/keyfile
          volumeMounts:
            - name: keyfile-secret
              mountPath: /tmp/keyfile
            - name: keyfile-copy
              mountPath: /etc/mongodb
      containers:
        - name: mongodb
          image: "mongo:5.0"
          imagePullPolicy: IfNotPresent
          command: ["mongod"]
          args:
            - "--replSet"
            - "rs0"
            - "--bind_ip_all"
            - "--keyFile"
            - "/etc/mongodb/keyfile"
          ports:
            - containerPort: 27017
              name: mongo
          volumeMounts:
            - name: datadir
              mountPath: /data/db
            - name: keyfile-copy
              mountPath: /etc/mongodb
              readOnly: true
            - name: rs-init-script
              mountPath: /config
              readOnly: true
          lifecycle:
            postStart:
              exec:
                command:
                  - "sh"
                  - "-c"
                  - |
                    exec > /proc/1/fd/1 2>/proc/1/fd/2
                    set -x
                    sleep 10;                 
                    for i in $(seq 1 30); do
                      if mongo --host localhost --eval "db.adminCommand('ping')" --quiet; then
                        echo "Mongo is up...";
                        break;
                      fi;
                      echo "Waiting for mongod to be ready ($i/30)...";
                      sleep 5;
                    done;
                    echo "Running replica set initiation script...";
                    mongo --host localhost /config/init.js || true;
                    exit 0
      volumes:
        - name: keyfile-secret
          secret:
            secretName: "mongo-keyfile"
            defaultMode: 0400
        - name: keyfile-copy
          emptyDir: {}
        - name: keyfile
          secret:
            secretName: "mongo-keyfile"
            defaultMode: 0400
        - name: rs-init-script
          configMap:
            name: mongodb-rs-init
  volumeClaimTemplates:
    - metadata:
        name: datadir
      spec:
        accessModes:
          - "ReadWriteOnce"
        storageClassName: "standard"
        resources:
          requests:
            storage: "2Gi"
---
# Source: mongodb-replicaset/templates/rs-init-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-rs-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": "before-hook-creation,hook-succeeded,hook-failed"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: mongodb-exec
      containers:
      - name: rs-init
        image: bitnami/kubectl:latest
        command:
          - "sh"
          - "-c"
          - |
            exec > /proc/1/fd/1 2>/proc/1/fd/2
            set -x
            echo "Sleeping 120 seconds to let MongoDB pods be ready..."
            sleep 120
            echo "Executing replica set initiation inside the primary pod..."
            kubectl exec mongodb-replicaset-0 -c mongodb -- mongo admin --eval '
              rs.initiate({
                _id: "rs0",
                members: [
                  { _id: 0, host: "mongodb-replicaset-0.mongodb-replicaset:27017" },
                  { _id: 1, host: "mongodb-replicaset-1.mongodb-replicaset:27017" },
                  { _id: 2, host: "mongodb-replicaset-2.mongodb-replicaset:27017" }
                ]
              })
            '
            sleep 20
      restartPolicy: OnFailure
